



<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="utf-8">
    <title>OpenSSH - Kody kontrolne, klucze, multiplexing, proxyjump | chyla.org</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="../../_static/IBM-Plex-Web-5.2.1/css/ibm-plex-mod.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-icons-1.4.0/bootstrap-icons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootswatch-cosmo-4-mod.css" type="text/css" />

	
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/chyla.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/chyla.css" />
    <link rel="shortcut icon" href="../../_static/logo-45x45.png"/>
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/pdfobject/pdfobject.min.js"></script>
    <script src="../../_static/translations.js"></script> 
  </head>

  <body>
    <nav class="navbar navbar-expand-md fixed-top chyla-navbar-light">
        <div class="navbar-brand-logo">
            <a class="navbar-brand" href="../../index.html">
                <img src="../../_static/logo-45x45.png" alt="Logo" id="logo" width="45px" height="45px">
            </a>
        </div>

        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="../../index.html">Cześć!</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../index.html">Artykuły</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../../edukacja/index.html">Edukacja</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../../repozytorium-pakietow/index.html">Repozytorium</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../../oprogramowanie/omtt.html">OMTT</a>
            </li>
          </ul>
        </div>

        <div class="navbar-nav navbar-right">
            <div id="searchbox" role="search">
                <div class="searchformwrapper">
                    <form class="search-form" action="../../search.html" method="get">
                        <div class="input-group">
                            <input id="navbar-search-input" class="form-control" type="text" name="q" placeholder="Szukamy?" aria-label="Search input field">
                            <div class="input-group-append">
                            <button type="submit" class="input-group-text"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <button class="navbar-toggler chyla-navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
             <i class="bi bi-list"></i>
        </button>
</nav>

<div id="navbar-placeholder"></div>
<main>
    <div class="document">
        <div class="container">
            <div class="body" role="main">
                
  <section id="openssh-kody-kontrolne-klucze-multiplexing-proxyjump">
<h1>OpenSSH - Kody kontrolne, klucze, multiplexing, proxyjump<a class="headerlink" href="#openssh-kody-kontrolne-klucze-multiplexing-proxyjump" title="Stały odnośnik do tego nagłówka">¶</a></h1>
<section id="spis-tresci">
<h2>Spis treści<a class="headerlink" href="#spis-tresci" title="Stały odnośnik do tego nagłówka">¶</a></h2>
<ol class="arabic simple">
<li><p>Kody kontrolne - ratunku, to połączenie umarło!</p></li>
<li><p>Klucze SSH - logowanie bez hasła</p></li>
<li><p>Multiplexing - jeden bezpieczny kanał komunikacji dla wszystkich sesji</p></li>
<li><p>ProxyJump - dostęp do systemu w sieci wewnętrznej za pomocą systemu pośredniczącego</p></li>
</ol>
</section>
<section id="kody-kontrolne">
<h2>Kody kontrolne<a class="headerlink" href="#kody-kontrolne" title="Stały odnośnik do tego nagłówka">¶</a></h2>
<p>Podczas sesji SSH ze zdalnym serwerem, czasami, dochodzi do sytuacji, w której nie jesteśmy w stanie nic zrobić. Klawiatura nie odpowiada, a wpisywane znaki nie pojawiają się na ekranie - to połączenie umarło! bo Wi-Fi zgubiło zasięg, a my nie używamy <a class="reference external" href="https://mosh.org/">Mosha</a>… gdyby tak móc powrócić do terminala…</p>
<p>Jest na to rada - trzeba zamknąć to połączenie. Jak? Bardzo prosto, w trzech krokach:</p>
<ul class="simple">
<li><p><cite>ENTER</cite></p></li>
<li><p><cite>~</cite></p></li>
<li><p><cite>.</cite></p></li>
</ul>
<p>Tak, wystarczy na klawiaturze nacisnąć po kolei <cite>ENTER</cite> <cite>~</cite> <cite>.</cite> - połączenie powinno zostać zamknięte, a my odzyskamy dostęp do terminala.</p>
<p>OpenSSH obsługuje kody kontrolne (escape codes) - specjalne polecenia dla dodatkowej kontroli programu. Polecenie takie zawsze zaczyna się od znaku tyldy, warto jednak zwrócić uwagę na dodatkowy <cite>ENTER</cite>. Kody kontrolne rozpoznawane są tylko wtedy, gdy występują bezpośrednio po znaku nowej linii (przykład: gdyby tak nie było, to mielibyśmy utrudnione użycie <cite>~</cite> jako odniesienia do katalogu domowego).</p>
<p>Pełną listę dostępnych sekwencji znajdziemy w pomocy… Ach tak, <cite>ENTER</cite> <cite>~</cite> <cite>?</cite>, polecam lekturę:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Supported escape sequences:
 ~.   - terminate connection (and any multiplexed sessions)
 ~B   - send a BREAK to the remote system
 ~C   - open a command line
 ~R   - request rekey
 ~V/v - decrease/increase verbosity (LogLevel)
 ~^Z  - suspend ssh
 ~#   - list forwarded connections
 ~&amp;   - background ssh (when waiting for connections to terminate)
 ~?   - this message
 ~~   - send the escape character by typing it twice
(Note that escapes are only recognized immediately after newline.)
</pre></div>
</div>
</section>
<section id="klucze-ssh">
<h2>Klucze SSH<a class="headerlink" href="#klucze-ssh" title="Stały odnośnik do tego nagłówka">¶</a></h2>
<p>Zwykle, przy nawiązywaniu połączenia, musimy podać hasło. Ten krok można jednak ominąć i zamiast hasła użyć klucza kryptograficznego. Na jego podstawie nastąpi automatyczne uwierzytelnienie, bez naszego udziału.</p>
<p>Czego potrzebujemy?</p>
<ul class="simple">
<li><p>wygenerowanej pary kluczy kryptograficzne - klucz publiczny i prywatny</p></li>
<li><p>jednorazowej wymiany klucza publicznego ze zdalną maszyną</p></li>
</ul>
<p>Wygenerowane klucze możemy znaleźć w katalogu <cite>~/.ssh/</cite> - zazwyczaj są to pliki <cite>id_rsa</cite> dla klucza prywatnego oraz <cite>id_rsa.pub</cite> dla klucza publicznego:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls  ~/.ssh
id_rsa  id_rsa.pub
</pre></div>
</div>
<p>Jeżeli ich nie mamy, możemy wygenerować je poleceniem <cite>ssh-keygen</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls -al ~/.ssh
ls: nie ma dostępu do &#39;/home/adam/.ssh&#39;: Nie ma takiego pliku ani katalogu

$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/adam/.ssh/id_rsa):
Created directory &#39;/home/adam/.ssh&#39;.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/adam/.ssh/id_rsa.
Your public key has been saved in /home/adam/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:wqKevwDql3zwvHHImIcP3zNS1L8Nyaj4xfhbpfh/4qk adam@Host
The key&#39;s randomart image is:
+---[RSA 2048]----+
|                 |
|                 |
|        .        |
|     . . .       |
|.   . + S + ..   |
|.. o=..oo..=o    |
|. +===oo.+ o+    |
|.. *=*++o o. o.. |
| .+.+=+ooo.E++o  |
+----[SHA256]-----+
</pre></div>
</div>
<p>Podczas tego procesu zostaniemy zapytani o hasło dla klucza. Będziemy o nie pytani za każdym razem, gdy spróbujemy danego klucza użyć. Nie do końca o to nam chodzi, w końcu chcemy logować się bez podawania hasła, dlatego z pełną odpowiedzialnością pomijamy to pytanie naciskając klawisz <cite>ENTER</cite>.</p>
<p>Drugim krokiem jest umieszczenie klucza publicznego na zdalnym serwerze. Wykonamy to za pomocą polecenia <cite>ssh-copy-id</cite> - dopisze ono zawartość naszego pliku <cite>id_rsa.pub</cite> do <cite>~/.ssh/authorized_keys</cite> na zdalnym serwerze (ten krok możemy także wykonać ręcznie):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh-copy-id adam@ZdalnySerwer
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
adam@ZdalnySerwer&#39;s password:

Number of key(s) added: 1

Now try logging into the machine, with:   &quot;ssh &#39;adam@ZdalnySerwer&#39;&quot;
and check to make sure that only the key(s) you wanted were added.
</pre></div>
</div>
<p>Od tego momentu możemy nawiązać połączenie SSH bez podawania hasła - do uwierzytelnienia zostaną wykorzystane klucze kryptograficzne. Zdalna maszyna, za pomocą klucza publicznego, zaszyfruje pewien ciąg danych, po czym wyśle go do naszej maszyny. Klient SSH, za pomocą klucza prywatnego, odszyfruje otrzymany ciąg i prześle go z powrotem do serwera, który sprawdzi poprawność otrzymanych danych.</p>
</section>
<section id="multiplexing">
<h2>Multiplexing<a class="headerlink" href="#multiplexing" title="Stały odnośnik do tego nagłówka">¶</a></h2>
<p>Tworząc nową sesję SSH, ze zdalnym serwerem, musi zostać nawiązane bezpieczne połączenie, a to jak wiadomo trwa (np. nawiązanie połączenia TCP, autoryzacja). Warto skonfigurować <a class="reference external" href="https://pl.wikipedia.org/wiki/Multipleksowanie">multipleksing</a>, czyli wykorzystywanie istniejącego, bezpiecznego kanału komunikacji podczas nawiązywania kolejnych sesji.</p>
<p>Odpowiednich zmian musimy dokonać w pliku konfiguracyjnym <cite>~/.ssh/config</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Host</span> <span class="o">*</span>
     <span class="n">ControlMaster</span>   <span class="n">auto</span>
     <span class="n">ControlPersist</span>  <span class="mi">10</span><span class="n">m</span>
     <span class="n">ControlPath</span>     <span class="o">~/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">sockets</span><span class="o">/%</span><span class="n">r</span><span class="o">@%</span><span class="n">h</span><span class="p">:</span><span class="o">%</span><span class="n">p</span>
</pre></div>
</div>
<p>Pierwsza linia informuje, że zdefiniowane niżej trzy parametry będą dotyczyły każdego połączenia.</p>
<ul class="simple">
<li><p><cite>ControlMaster</cite> włącza multipleksing</p></li>
<li><p><cite>ControlPersist</cite> określa czas, przez który połączenie ma zostać podtrzymane, po zakończończeniu ostatniej sesji</p></li>
<li><p><cite>ControlPath</cite> określa ścieżkę do gniazda kontrolnego</p></li>
</ul>
</section>
<section id="proxyjump">
<h2>ProxyJump<a class="headerlink" href="#proxyjump" title="Stały odnośnik do tego nagłówka">¶</a></h2>
<p>Mając dostęp do tylko jednego serwera wystawionego na świat możemy uzyskać dostęp do pozostałych systemów w zamkniętej sieci. <cite>ProxyJump</cite> pozwala na nawiązanie połączenia z dowolnym serwerem za pomocą pośrednika.</p>
<p>Załóżmy, że chcemy nawiązać połączenie z serwerem o nazwie <cite>Intra</cite> - znajduje się on wewnątrz zamkniętej sieci, dostęp do tej sieci otrzymujemy poprzez system o nazwie <cite>Gate</cite>.</p>
<figure class="align-default" id="id1">
<img alt="../../_images/openssh-kody-kontrolne-klucze-ssh-multiplexing-proxyjump-schemat-sieci.png" src="../../_images/openssh-kody-kontrolne-klucze-ssh-multiplexing-proxyjump-schemat-sieci.png" />
<figcaption>
<p><span class="caption-text">Ilustracja 1: Schemat sieci.</span><a class="headerlink" href="#id1" title="Stały odnośnik do tego obrazu">¶</a></p>
</figcaption>
</figure>
<p>Połączenie od naszego hosta do systemu <cite>Intra</cite> możemy nawiązać za pomocą polecenia:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">J</span> <span class="n">user</span><span class="nd">@gate</span> <span class="n">user</span><span class="nd">@intra</span>
</pre></div>
</div>
<p>Gdy często łączymy się z hostem <cite>Intra</cite> warto rozważyć dodatkową konfigurację (<cite>~/.ssh/config</cite>), która uprości proces:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Host</span> <span class="n">intra</span>
     <span class="n">HostName</span>  <span class="n">intra</span>
     <span class="n">ProxyJump</span> <span class="n">user</span><span class="nd">@gate</span><span class="p">:</span><span class="mi">22</span>
     <span class="n">User</span>      <span class="n">user</span>
</pre></div>
</div>
<p>Z powyższą konfiguracją, polecenie nawiązania połączenia z hostem <cite>Intra</cite> jest następujące:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">intra</span>
</pre></div>
</div>
<p>Starsze wersje OpenSSH nie obsługują komendy <cite>ProxyJump</cite>, dlatego zamiast niej stosowano <cite>ProxyCommand</cite> [4, 5].</p>
</section>
<section id="literatura">
<h2>Literatura<a class="headerlink" href="#literatura" title="Stały odnośnik do tego nagłówka">¶</a></h2>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://www.digitalocean.com/community/tutorials/ssh-essentials-working-with-ssh-servers-clients-and-keys">SSH Essentials: Working with SSH Servers, Clients, and Keys</a></p></li>
<li><p><a class="reference external" href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing">https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing</a></p></li>
<li><p><a class="reference external" href="http://man.openbsd.org/ssh_config.5">SSH_CONFIG(5)</a></p></li>
<li><p><a class="reference external" href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts">OpenSSH/Cookbook/Proxies and Jump Hosts</a></p></li>
<li><p><a class="reference external" href="http://blog.stelmisoft.pl/2010/zdalny-dostepu-do-sieci-wewnetrznej-przy-uzyciu-protokolu-ssh/">Zdalny dostępu do sieci wewnętrznej przy użyciu protokołu SSH</a></p></li>
</ol>
</section>
</section>


                <div class="clearer"></div>
            </div>
        </div>
    </div>
</main>


    <footer id="footer" class="chyla-footer-light">
        <div class="row">
            <div class="footer-box footer-infos col-md-10">
				
<h5>Adam Chyła</h5>
<p>Specjalista ds. Rozwoju Oprogramowania</p>

            </div>
            <div class="footer-box chyla-footer-social-list col-md-2">
                <h5>Social media</h5>
                <ul>
					
<li><a href="https://github.com/chyla" target="_blank"><i class="bi bi-github"></i></a></li>

				</ul>
            </div>
        </div>

        <div class="row">
            <div class="footer-box footer-law col-md-12">
				
<p>Witryna prywatna. Każda opinia wyrażona w tej wirtynie jest wyłącznie moją opinią (nie jest to opinia mojego pracodawcy).<br/>
   Private website. All opinions expressed here are only mine (not of my employer).</p>

<p><a href="/law/nota_prawna.html">Zapoznaj się z notą prawną dotyczącą treści i funkcjonowania portalu</a> oraz <a href="/law/polityka_prywatnosci_i_plikow_cookies.html">polityką prywatności i plików cookie</a>.</p>

            </div>
        </div>
    </footer>

    <script src="../../_static/bootstrap-4.6/bootstrap.bundle.min.js"></script>
	
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-90323199-1', 'auto');
    ga('send', 'pageview');
</script>


  </body>
</html>